<!DOCTYPE html>
<html lang="en">

<head>

    <title>Guardian Meme Generator</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="resources/jquery-ui.min.css">
    <link rel="stylesheet" href="resources/bootstrap.css">
    <link rel="stylesheet" href="resources/lity.css">
    <link rel="stylesheet" href="resources/beta.css">
    <link rel="stylesheet" href="resources/fonts.css">

    <script src="resources/jquery.min.js"></script>
    <script src="resources/jquery-ui.min.js"></script>
    <script src="resources/bootstrap.js"></script>
    <script src="resources/html2canvas.1.0.0.rc3.js"></script>
    <script src="resources/lity.js"></script>
    <script src="resources/FileSaver.138.js"></script>

</head>

<body>
    <div class="content">
        <div class="container">
            <div class="row">
                <div class="col-xs-12 col-sm-12">

                    <div class="alert alert-info center-text alert-dismissible ie_warning">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        <strong>
                            This site does not support Internet Explorer or Microsoft Edge due to a lack of the necessary features required
                            <br>
                            <br>
                            Please use a decent browser. Think of the kittens
                        </strong>
                    </div>

                    <!-- meme-bg-target -->
                    <div id="meme-bg-target">
                        <div class="wrap">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="top-container">
                                        <div class="top-element">
                                            <div placeholder="Click here to type your meme" contenteditable="true" class="meme-txt-area" id="meme-txt-area"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="bottom-container">
                                        <div class="bottom-element">
                                            <div class="meme-name-area">Simon Hedges</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="photo">
                            <img src="images/mugshots/hedges.png" crossorigin="anonymous">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="journo">Journalist</label>
                        <input type="text" class="form-control" id="journo" value="Simon Hedges">
                    </div>
                    <!-- End meme-bg-target -->
                    <!-- meme-control -->
                    <div class="row text-center">
                        <div class="col-xs-12 col-sm-12 col-md-2 center-text">
                            <!-- font size / download row -->
                            <div class="btn-group btn-group-xs btn-group-sm">
                                <div class="col-xs-4 col-sm-4 col-md-8">
                                    <div class="btn-group btn-group-md">
                                        <!--                    <p class="h4">Save</p>-->
                                        <button type="button" name="save-as-image" id="save-as-image" class="btn btn-primary">Download Meme</button>
                                    </div>
                                </div>
                                <div class="col-xs-8 col-sm-8 col-md-8">
                                    <p class="h4">Font Size</p>
                                    <button type="button" value="Smaller" class="btn btn-primary qtyminus">Smaller</button>
                                    <button type="button" value="Larger" class="btn btn-primary qtyplus">Larger</button>
                                    <p>
                                        Hide Text Box
                                        <input type="checkbox" id="hide">
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- end of font size / download row -->

                        <div class="col-xs-12 col-sm-12 col-md-8">
                            <!-- Names row -->
                            <div class="btn-group btn-group-md">

                                <p class="h4">Sound people</p>

                                <button type="button" class="btn btn-primary name" name="Simon Hedges" value="hedges">Simon Hedges</button>
                                <button type="button" class="btn btn-primary name" name="Frampton Essex" value="frammattb">Frampton Essex</button>
                                <button type="button" class="btn btn-primary name" name="Pharley Smith" value="phargouty">Pharley Smith</button>


                            </div>
                            
                            
                            <div class="btn-group btn-group-md">
                                <p class="h4">Billionaire Beggers</p>
                                <button type="button" class="btn btn-primary name" name="Bono" value="bono">Bono</button>
                            </div>
                            <div class="btn-group btn-group-md">
                                <p class="h4">War</p>
                                <button type="button" class="btn btn-primary name" name="Vladimir Putin" value="putin">Vladimir Putin</button>
                                <button type="button" class="btn btn-primary name" name="Vladimir Putin" value="putin2">Putin 2</button>
                                <button type="button" class="btn btn-primary name" name="Tony B. Liar" value="bliar">Tony Blair</button>
                                <button type="button" class="btn btn-primary name" name="Barack Obama" value="obama">Barack Obama</button>
                                <button type="button" class="btn btn-primary name" name="Brains" value="brains">Brains</button>
                            </div>
                            <div class="btn-group btn-group-md">
                                <p class="h4">Religion</p>
                                <button type="button" class="btn btn-primary name" name="Margaret Thatcher" value="thatcher">Thatcher</button>
                                <button type="button" class="btn btn-primary name" name="Jesus Christ" value="jesus">Jesus Christ</button>
                                <button type="button" class="btn btn-primary name" name="Queen Elizabeth II" value="qe2">QE2</button>
                            </div>
                            <div class="btn-group btn-group-md">
                                <p class="h4">Sport</p>
                                <button type="button" class="btn btn-primary name" name="Barry Robson" value="barry">Barry Robson</button>
                            </div>
                            <div class="btn-group btn-group-md">
                                <p class="h4">Satirists</p>
                                <button type='button' class="btn btn-primary name" name="Jonathan Pie" value="pie">Jonathan Pie</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end of Names row -->
            </div>
        </div>
    </div>
    <!-- End meme-control -->
    <div class="col-xs-12 col-sm-12 text-center" id="footer">
        <div class="debug"></div>
        <div id="debugoutput"></div>
    </div>
    </div>
    </div>

</body>

<script>
    function exportCanvas() {

        /* scroll to the top of the page */
        window.scrollTo(0, 0);

        /* hide the text border from the export */
        $(".meme-txt-area").css('border', '0 none transparent');

        html2canvas(document.querySelector("#meme-bg-target"), {
            allowTaint: true,
            useCORS: true
        }).then(canvas => {

                var ua = window.navigator.userAgent;
                var iOS = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i);
                var webkit = !!ua.match(/WebKit/i);
                var iOSSafari = iOS && webkit && !ua.match(/CriOS/i);

                // ONLY for ios on safari, it sucks but not as much as Apple having this bug open for 5 years.
                if (iOS) {

                    // handle non-a[download] safari as best we can:
                    if (confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")) {
                        lity(canvas.toDataURL());
                    }

                } else {
                    if (!window.localStorage) {
                        alert("This function is not supported by your browser.");
                        return;
                    }

                    try {

                        var c = canvas.toDataURL().replace("data:image/png;base64,", "");

                        var blob = new Blob([b64toBlob(c)], {
                            type: "image/png"
                        });

                        saveAs(blob, "guardianmeme.png");

                    } catch (e) {
                        alert("Your browser is configured to block the image being generated. Brave (with frintprint prevention) and Firefox Focus do this. Please try another browser")
                    }



                }

                if ($('#hide[type=checkbox]').prop('checked') == false)
                    $(".meme-txt-area").css('border', '2px red dotted');

            }

        );

    }

    function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length;

            offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length;

                i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {
                type: contentType
            }

        );
        return blob;
    }

    /**  
     * detect IE
     * returns version of IE or false, if browser is not Internet Explorer
     */
    function detectIE() {
        var ua = window.navigator.userAgent;

        // Test values; Uncomment to check result 

        // IE 10
        // ua = 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2;
        // Trident/6.0)';

        // IE 11
        // ua = 'Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko';

        // Edge 12 (Spartan)
        // ua = 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML,
        // like Gecko) Chrome/39.0.2171.71 Safari/537.36 Edge/12.0';

        // Edge 13    
        // ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36  
        // (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10586';

        var msie = ua.indexOf('MSIE ');

        if (msie > 0) {
            // IE 10 or older => return version number
            return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
        }

        var trident = ua.indexOf('Trident/');

        if (trident > 0) {
            // IE 11 => return version number
            var rv = ua.indexOf('rv:');
            return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
        }

        var edge = ua.indexOf('Edge/');

        if (edge > 0) {
            // Edge (IE 12+) => return version number
            return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
        }

        // other browser
        return false;
    }


    function rgb2hex(rgb) {
        rgb = rgb.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?, [\s+]?(\d+)[\s+]?, [\s+]?(\d+)[\s+]?/i);
        return (rgb && rgb.length === 4) ? "#" + ("0" + parseInt(rgb[1], 10).toString(16)).slice(-2) + ("0" + parseInt(rgb[2], 10).toString(16)).slice(-2) + ("0" + parseInt(rgb[3], 10).toString(16)).slice(-2) : '';
    }


    $(document).ready(function(e) {

            $('#journo').on('input', function() {
                $(".meme-name-area").text($(this).val());
            });

            $(".name").click(function() {
                    $(".photo img").attr('src', 'images/mugshots/' + this.value + '.png');
                    $(".photo img").attr('crossOrigin', 'Anonymous');
                    $(".meme-name-area").text(this.name);
                    $('#journo').val(this.name);
                }
            );

            $("#save-as-image").on('click', function() {
                exportCanvas();
            });

            // hide the guide lines
            $("#hide").change(function() {
                    if ($('#hide[type=checkbox]').prop('checked'))
                        $(".meme-txt-area").css('border', '0 none transparent');
                    else
                        $(".meme-txt-area").css('border', '2px red dotted');
                }

            );

            //    $(".meme-txt-area").draggable();
            //    $(".meme-txt-area").focus();

            // all editable content is text only
            $("div[contenteditable=true]").off('paste').on('paste', function(e) {
                    e.preventDefault();
                    var text = e.originalEvent.clipboardData ? e.originalEvent.clipboardData.getData('text/plain') : window.clipboardData.getData('Text');
                    _insertText(text);
                }

            );

            function _insertText(text) {

                // use insertText command if supported
                if (document.queryCommandSupported('insertText')) {
                    document.execCommand('insertText', false, text);
                } else // or insert the text content at the caret's current position
                // replacing eventually selected content
                {
                    var range = document.getSelection().getRangeAt(0);
                    range.deleteContents();
                    var textNode = document.createTextNode(text);
                    range.insertNode(textNode);
                    range.selectNodeContents(textNode);
                    range.collapse(false);

                    var selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }

            ;

            // font size up/down
            $('.qtyplus').click(function(e) {
                    // Stop acting like a button
                    e.preventDefault();
                    // Get the field name
                    var currentVal = parseInt($('.meme-txt-area').css("font-size").replace('px', ''));

                    // If is not undefined
                    if (!isNaN(currentVal)) {
                        // change the css    
                        currentVal++;
                        $('.meme-txt-area').css("font-size", currentVal + 'px');
                    }
                }

            );

            // This button will decrement the value till 0
            $(".qtyminus").click(function(e) {
                    // Stop acting like a button
                    e.preventDefault();
                    // Get the field name
                    var currentVal = parseInt($('.meme-txt-area').css("font-size").replace('px', ''));

                    // If it isn't undefined or its greater than 0
                    if (!isNaN(currentVal) && currentVal > 0) {
                        // Decrement one
                        currentVal--;
                        $('.meme-txt-area').css("font-size", currentVal + 'px');
                    } else {
                        // Otherwise put a 0 there
                        $('.meme-txt-area').css("font-size", '0px');
                    }

                    // change the css        
                    $('.meme-txt-area').css("font-size", currentVal);

                }

            );

            // if user clicks on the footer, then give some screen size details
            $("#footer").click(function(e) {
                    var bg = $(".debug").css('background-color');
                    $("#debugoutput").text(rgb2hex(bg) + ' ' + document.body.clientWidth + 'x' + document.body.clientHeight);
                }

            );

            // ie is shit - get IE or Edge browser version
            var version = detectIE();

            if (version != null && version != false && version < 15) {
                $(".ie_warning").show();
            }


            $(".meme-txt-area").focus();

        }

    );
</script>

</html>
